:: Test-Sex-Encounter [nobr]

<<if !$ui || !$ui.npc>>
	ERROR: ui.npc not set
	<<return>>
<</if>>
<<set _npc = $ui.npc>>
<<set _n = _npc>>
<<run setup.normalizeBodyparts($mc)>>
<<run setup.normalizeBodyparts(_n)>>

<<if !$mc.bodyparts && $mc.body>>
	<<set $mc.bodyparts = Object.keys($mc.body)>>
<</if>>

/* ensure room exists BEFORE UI */
<<if !$room>>
<<set $room = {
  type: "bedroom",
  location: "large floor",
  furnitureFlags: setup.getRoomFurnitureFlags("bedroom")
}>>
<</if>>

/* ensure sex exists */

/* <<set $sex = {
  position: "Standing",
  role: "top",
  subject: $mc,
  object: _n,
  engagedParts: { subject: [], object: [] },
  penetration: null,
  phase: "tease",
  history: []
}>> */
<<SexMemory>>
/* local convenience copy */
<<set _sexCount = $npcMemory[_key].sexCount>>

<<if $sex.roles.dom.name == $mc.name>>
  <<set $sex.role = "top">>
<<else>>
  <<set $sex.role = "bottom">>
<</if>>

<<set $sex.position = "Standing">>
<<set $sex.subject = $sex.roles.dom.name>>
<<set $sex.object = $sex.roles.sub.name>>
<<set $sex.engagedParts= { subject: [], object: [] }>>
<<set $sex.penetration = null>>
<<set $sex.phase = "tease">>
<<set $sex.history= []>>
<<set $sex.action= "Staring">>

/* ALWAYS rebind subject/object to current */
<<set $sex.subject = $mc>>
<<set $sex.object  = _n>>

/* keep furniture flags synced */
<<set $room.furnitureFlags = $room.furnitureFlags || setup.getRoomFurnitureFlags($room.type)>>
<<set $sex.furnitureFlags  = $room.furnitureFlags>>

/* MC parts: <<print $mc.bodyparts.join(", ")>><br>
NPC parts: <<print _n.bodyparts.join(", ")>><br> */

<<set _n.arousal = _n.arousal or 0>>
<<set $mc.arousal = $mc.arousal or 0>>

/* Arousal bar*/
<div id="arousal-ui">
  <<ArousalUI>>
</div>

<div id= "sex-container">
<<RoomRelocationUI>>
<br>
 <<SexEncounterUI>>
</div>

