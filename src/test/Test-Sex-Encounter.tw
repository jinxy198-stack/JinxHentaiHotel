:: Test-Sex-Encounter [nobr]

<<if !$ui || !$ui.npc>>
	ERROR: ui.npc not set
	<<return>>
<</if>>
<<set _npc = $ui.npc>>
<<set _n = _npc>>
<<run setup.normalizeBodyparts($mc)>>
<<run setup.normalizeBodyparts(_n)>>

<<if !$mc.bodyparts && $mc.body>>
	<<set $mc.bodyparts = Object.keys($mc.body)>>
<</if>>

<hr>

/* ensure room exists BEFORE UI */
<<if !$room>>
<<set $room = {
  type: "bedroom",
  location: "large floor",
  furnitureFlags: setup.getRoomFurnitureFlags("bedroom")
}>>
<</if>>

/* ensure sex exists */

/* <<set $sex = {
  position: "Standing",
  role: "top",
  subject: $mc,
  object: _n,
  engagedParts: { subject: [], object: [] },
  penetration: null,
  phase: "tease",
  history: []
}>> */
<<SexMemory>>
/* local convenience copy */
	<<set _sexCount = $npcMemory[_key].sexCount>>

<<set $sex.position = "Standing">>
<<set $sex.subject = $mc>>
<<set $sex.object = _n>>
<<set $sex.engagedParts= { subject: [], object: [] }>>
<<set $sex.penetration = null>>
<<set $sex.phase = "tease">>
<<set $sex.history= []>>
<<set $sex.action= "Staring">>


<<if $sex.roles.dom.name == $mc.name>>
  <<set $sex.role = "top">>
<<else>>
  <<set $sex.role = "bottom">>
<</if>>


/* ALWAYS rebind subject/object to current */
<<set $sex.subject = $mc>>
<<set $sex.object  = _n>>

/* keep furniture flags synced */
<<set $room.furnitureFlags = $room.furnitureFlags || setup.getRoomFurnitureFlags($room.type)>>
<<set $sex.furnitureFlags  = $room.furnitureFlags>>

MC parts: <<print $mc.bodyparts.join(", ")>><br>
NPC parts: <<print _n.bodyparts.join(", ")>><br>

<<set _n.arousal = _n.arousal or 0>>
/* <<print JSON.stringify($sex)>> <br>*/
/* <<print setup.getAvailablePositions($sex)>> <br>*/
 /* <<print setup.getAvailableSexActs($sex)>> <br>*/
/* <<print Object.keys(setup.sexacts)>> */
/* <<print JSON.stringify(setup.getAvailablePositions($sex))>> */
/*<b>Last relocation pressed:</b> <<print $debugLastRelocation>>*/

/* Arousal bar*/
<div class="status-line">
			<span class="status-label">Arousal: </span>
			<span class="status-value">
				<progress id="arousal-bar" value="<<=_n.arousal>>" max="100"></progress>
				<span id="arousal-pct"><<= _n.arousal >>%</span>
			</span>
</div>


<div id= "sex-container">
<<RoomRelocationUI>>
<br>
<<SexEncounterUI>>
</div>

